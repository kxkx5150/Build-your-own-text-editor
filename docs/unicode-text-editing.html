<html><head>
    <meta charset="utf-8">

<title>Unicode Text Editing - Catch22</title>
<meta name="description" content="Unicode character input presents some unique problems for text-editors - issues that did not have to be considered when the first ASCII editors were written. The main difficulties are the Unicode ‘combining sequences’ - where multiple code-points are combined to form a single selectable ‘character cluster’. Modifications to a Unicode text-file require careful coding to ensure that character cluster-boundaries are preserved and that no invalid sequences are inadvertantly introduced into the document. The Uniscribe API will again be used to aid us in this area.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Catch22">
<meta property="og:title" content="Unicode Text Editing">
<meta property="og:url" content="unicode-text-editing">


  <meta property="og:description" content="Unicode character input presents some unique problems for text-editors - issues that did not have to be considered when the first ASCII editors were written. The main difficulties are the Unicode ‘combining sequences’ - where multiple code-points are combined to form a single selectable ‘character cluster’. Modifications to a Unicode text-file require careful coding to ensure that character cluster-boundaries are preserved and that no invalid sequences are inadvertantly introduced into the document. The Uniscribe API will again be used to aid us in this area.">







  <meta property="article:published_time" content="2006-11-28T00:00:00+00:00">






<style type="text/css">svg:not(:root).svg-inline--fa{overflow:visible}.svg-inline--fa{display:inline-block;font-size:inherit;height:1em;overflow:visible;vertical-align:-.125em}.svg-inline--fa.fa-lg{vertical-align:-.225em}.svg-inline--fa.fa-w-1{width:.0625em}.svg-inline--fa.fa-w-2{width:.125em}.svg-inline--fa.fa-w-3{width:.1875em}.svg-inline--fa.fa-w-4{width:.25em}.svg-inline--fa.fa-w-5{width:.3125em}.svg-inline--fa.fa-w-6{width:.375em}.svg-inline--fa.fa-w-7{width:.4375em}.svg-inline--fa.fa-w-8{width:.5em}.svg-inline--fa.fa-w-9{width:.5625em}.svg-inline--fa.fa-w-10{width:.625em}.svg-inline--fa.fa-w-11{width:.6875em}.svg-inline--fa.fa-w-12{width:.75em}.svg-inline--fa.fa-w-13{width:.8125em}.svg-inline--fa.fa-w-14{width:.875em}.svg-inline--fa.fa-w-15{width:.9375em}.svg-inline--fa.fa-w-16{width:1em}.svg-inline--fa.fa-w-17{width:1.0625em}.svg-inline--fa.fa-w-18{width:1.125em}.svg-inline--fa.fa-w-19{width:1.1875em}.svg-inline--fa.fa-w-20{width:1.25em}.svg-inline--fa.fa-pull-left{margin-right:.3em;width:auto}.svg-inline--fa.fa-pull-right{margin-left:.3em;width:auto}.svg-inline--fa.fa-border{height:1.5em}.svg-inline--fa.fa-li{width:2em}.svg-inline--fa.fa-fw{width:1.25em}.fa-layers svg.svg-inline--fa{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.fa-layers{display:inline-block;height:1em;position:relative;text-align:center;vertical-align:-.125em;width:1em}.fa-layers svg.svg-inline--fa{-webkit-transform-origin:center center;transform-origin:center center}.fa-layers-counter,.fa-layers-text{display:inline-block;position:absolute;text-align:center}.fa-layers-text{left:50%;top:50%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);-webkit-transform-origin:center center;transform-origin:center center}.fa-layers-counter{background-color:#ff253a;border-radius:1em;-webkit-box-sizing:border-box;box-sizing:border-box;color:#fff;height:1.5em;line-height:1;max-width:5em;min-width:1.5em;overflow:hidden;padding:.25em;right:0;text-overflow:ellipsis;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top right;transform-origin:top right}.fa-layers-bottom-right{bottom:0;right:0;top:auto;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:bottom right;transform-origin:bottom right}.fa-layers-bottom-left{bottom:0;left:0;right:auto;top:auto;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:bottom left;transform-origin:bottom left}.fa-layers-top-right{right:0;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top right;transform-origin:top right}.fa-layers-top-left{left:0;right:auto;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top left;transform-origin:top left}.fa-lg{font-size:1.3333333333em;line-height:.75em;vertical-align:-.0667em}.fa-xs{font-size:.75em}.fa-sm{font-size:.875em}.fa-1x{font-size:1em}.fa-2x{font-size:2em}.fa-3x{font-size:3em}.fa-4x{font-size:4em}.fa-5x{font-size:5em}.fa-6x{font-size:6em}.fa-7x{font-size:7em}.fa-8x{font-size:8em}.fa-9x{font-size:9em}.fa-10x{font-size:10em}.fa-fw{text-align:center;width:1.25em}.fa-ul{list-style-type:none;margin-left:2.5em;padding-left:0}.fa-ul>li{position:relative}.fa-li{left:-2em;position:absolute;text-align:center;width:2em;line-height:inherit}.fa-border{border:solid .08em #eee;border-radius:.1em;padding:.2em .25em .15em}.fa-pull-left{float:left}.fa-pull-right{float:right}.fa.fa-pull-left,.fab.fa-pull-left,.fal.fa-pull-left,.far.fa-pull-left,.fas.fa-pull-left{margin-right:.3em}.fa.fa-pull-right,.fab.fa-pull-right,.fal.fa-pull-right,.far.fa-pull-right,.fas.fa-pull-right{margin-left:.3em}.fa-spin{-webkit-animation:fa-spin 2s infinite linear;animation:fa-spin 2s infinite linear}.fa-pulse{-webkit-animation:fa-spin 1s infinite steps(8);animation:fa-spin 1s infinite steps(8)}@-webkit-keyframes fa-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes fa-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}.fa-rotate-90{-webkit-transform:rotate(90deg);transform:rotate(90deg)}.fa-rotate-180{-webkit-transform:rotate(180deg);transform:rotate(180deg)}.fa-rotate-270{-webkit-transform:rotate(270deg);transform:rotate(270deg)}.fa-flip-horizontal{-webkit-transform:scale(-1,1);transform:scale(-1,1)}.fa-flip-vertical{-webkit-transform:scale(1,-1);transform:scale(1,-1)}.fa-flip-horizontal.fa-flip-vertical{-webkit-transform:scale(-1,-1);transform:scale(-1,-1)}:root .fa-flip-horizontal,:root .fa-flip-vertical,:root .fa-rotate-180,:root .fa-rotate-270,:root .fa-rotate-90{-webkit-filter:none;filter:none}.fa-stack{display:inline-block;height:2em;position:relative;width:2.5em}.fa-stack-1x,.fa-stack-2x{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.svg-inline--fa.fa-stack-1x{height:1em;width:1.25em}.svg-inline--fa.fa-stack-2x{height:2em;width:2.5em}.fa-inverse{color:#fff}.sr-only{border:0;clip:rect(0,0,0,0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.sr-only-focusable:active,.sr-only-focusable:focus{clip:auto;height:auto;margin:0;overflow:visible;position:static;width:auto}</style><link rel="canonical" href="unicode-text-editing.html">













<!-- end _includes/seo.html -->


<link href="../../feed.xml" type="application/atom+xml" rel="alternate" title="Catch22 Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  <style id="fit-vids-style">.fluid-width-video-wrapper{width:100%;position:relative;padding:0;}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper object,.fluid-width-video-wrapper embed {position:absolute;top:0;left:0;width:100%;height:100%;}</style></head>

  <body class="layout--tutorial wide" style="margin-bottom: 171.375px;">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="../../index.html">Catch22</a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="../../blog/index.html">Blog</a>
            </li><li class="masthead__menu-item">
              <a href="../../software/index.html">Software</a>
            </li><li class="masthead__menu-item">
              <a href="../../tuts/index.html">Tutorials</a>
            </li><li class="masthead__menu-item">
              <a href="../../about/index.html">About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button" count="0" style="">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope="" itemtype="../../../schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope="" itemtype="../../../schema.org/ListItem">
          <a href="../../index.html" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope="" itemtype="../../../schema.org/ListItem">
          <a href="../../tuts.html" itemprop="item"><span itemprop="name">Tuts</span></a>
          <meta itemprop="position" content="2">
        </li>
        <span class="sep">/</span>
                
      
    
      
      
        
        <li itemprop="itemListElement" itemscope="" itemtype="../../../schema.org/ListItem">
          <a href="../../tuts/neatpad.html" itemprop="item"><span itemprop="name">Neatpad</span></a>
          <meta itemprop="position" content="3">
        </li>
        <span class="sep">/</span>
                
      
    
      
      
        <li class="current">Unicode Text Editing</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      
  <div class="file-attachments">
    <h4>DOWNLOADS</h4>
    
      
       <a href="assets/files/neatpad18.zip">neatpad18.zip</a>      
    
  </div>

    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox">
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Neatpad</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="" class=""></a></li>
          
            
            

            
            

            <li><a href="index.html" class="">Neatpad Overview</a></li>
          
            
            

            
            

            <li><a href="loading-text-file.html" class="">Loading a text file</a></li>
          
            
            

            
            

            <li><a href="scrollbars-scrolling.html" class="">Scrollbars &amp; Scrolling</a></li>
          
            
            

            
            

            <li><a href="enhanced-drawing-painting.html" class="">Enhanced Drawing &amp; Painting</a></li>
          
            
            

            
            

            <li><a href="mouse-selection-highlighting.html" class="">Mouse Selection &amp; Highlighting</a></li>
          
            
            

            
            

            <li><a href="scrolling-mouse.html" class="">Scrolling with the Mouse</a></li>
          
            
            

            
            

            <li><a href="margins-and-long-lines.html" class="">Margins and Long Lines</a></li>
          
            
            

            
            

            <li><a href="introduction-unicode.html" class="">Introduction to Unicode</a></li>
          
            
            

            
            

            <li><a href="unicode-text-processing.html" class="">Unicode Text Processing</a></li>
          
            
            

            
            

            <li><a href="transparent-text.html" class="">Transparent Text</a></li>
          
            
            

            
            

            <li><a href="introduction-uniscribe.html" class="">Introduction to Uniscribe</a></li>
          
            
            

            
            

            <li><a href="uniscribe-mysteries.html" class="">Uniscribe Mysteries</a></li>
          
            
            

            
            

            <li><a href="more-uniscribe-mysteries.html" class="">More Uniscribe Mysteries</a></li>
          
            
            

            
            

            <li><a href="drawing-styled-text-uniscribe.html" class="">Drawing styled text with Uniscribe</a></li>
          
            
            

            
            

            <li><a href="integrating-usplib.html" class="">Integrating UspLib</a></li>
          
            
            

            
            

            <li><a href="keyboard-navigation.html" class="">Keyboard Navigation</a></li>
          
            
            

            
            

            <li><a href="piece-chains.html" class="">Piece Chains</a></li>
          
            
            

            
            

            <li><a href="unicode-text-editing.html" class="active">Unicode Text Editing</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    

  
  </div>


  <article class="page" itemscope="" itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Unicode Text Editing">
    <meta itemprop="description" content="Unicode character input presents some unique problems for text-editors - issues that did not have to be considered when the first ASCII editors were written. The main difficulties are the Unicode ‘combining sequences’ - where multiple code-points are combined to form a single selectable ‘character cluster’. Modifications to a Unicode text-file require careful coding to ensure that character cluster-boundaries are preserved and that no invalid sequences are inadvertantly introduced into the document. The Uniscribe API will again be used to aid us in this area.">
    <meta itemprop="datePublished" content="November 28, 2006">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Unicode Text Editing
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <!--h1>Unicode Text Editing</h1-->
<!--h3>Editing complex script</h3-->

<p>Unicode文字の入力は、テキストエディターにいくつかのユニークな問題をもたらします。これは、最初のASCIIエディターが書かれたときには考慮する必要がなかった問題です。主な問題点は、Unicodeの「結合シーケンス」です。複数のコードポイントを結合して、選択可能な1つの「文字クラスタ」を形成します。Unicodeテキストファイルへの変更は、文字クラスタの境界が維持され、無効なシーケンスが不用意にドキュメントに導入されないように、慎重なコーディングが必要です。この分野では、Uniscribe API が再び使用されます。

</p>

<p>どのような種類の文字入力も、ドキュメントへの変更を管理し、表現するための何らかのデータ構造がなければ実現できません。前回のチュートリアルでは、挿入、消去、置換の3つの基本的な編集操作を実現するピーステーブルデータ構造を実装しました。無制限の元に戻す、やり直しもサポートされています。シーケンスクラスは、ピーステーブルとこれらの基本的な編集操作を1つのC++オブジェクトにカプセル化したものです。このチュートリアルの目的は、ピーステーブル編集モデルをサポートするために、Neatpadに必要な修正を記録することです。


</p>

<h2 id="unicode-character-input">Unicode character input</h2>

<p>第16回「キーボードナビゲーション」では、Unicode文書内でのキャレットの移動について説明し、キーボード入力を受け取る際にプログラムが遭遇するさまざまなWin32文字入力メッセージについても簡単に説明しました。

</p>

<table>
  <tbody>
    <tr>
      <td>&nbsp;</td>
      <td>Characters</td>
      <td>Dead Characters</td>
    </tr>
    <tr>
      <td>UTF-16 Character</td>
      <td><strong>WM_CHAR</strong></td>
      <td>WM_DEADCHAR</td>
    </tr>
    <tr>
      <td>UTF-32 Character</td>
      <td>WM_UNICHAR</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td>Input Method Editor</td>
      <td>WM_IME_CHAR</td>
      <td>&nbsp;</td>
    </tr>
    <tr>
      <td>System Character</td>
      <td>WM_SYSCHAR</td>
      <td>WM_DEADSYSCHAR</td>
    </tr>
  </tbody>
</table>

<p>WM_CHARメッセージは、Windowsの最初のバージョンから存在しているにもかかわらず、Win32アプリケーションが文字入力を受け取るための最も適切な方法です。どんなUNICODEアプリケーションでも、WM_CHARメッセージは、普通のANSI文字ではなく、1つのUTF-16文字値を送信します。NeatpadはすでにUTF-16（ワイドキャラクタ）アプリケーションなので、これは完璧です。なぜなら、これらの言語のキーボード入力は、通常、Input Method Editor (IME)に関連付けられているからです。IMEは、私たちが余分な作業をしなくても、「複雑な」キーストロークを適切なUTF-16文字のストリームに変換します。Windowsの入力メソッドエディタについては、次回のチュートリアルでご紹介します。

</p>

<p>他のメッセージは面白そうですが、実際には必要ありません。WM_UNICHARメッセージは、16bitのWCHARではなく、UTF-32の文字を送信すると思われますが、XPマシンでもWM_UNICHARがプログラムに送信されているのを見たことがありません。これは、OS自体ではなく、他のアプリケーション（IMEなど）が送信するメッセージなのではないかと思います。同様に、WM_IME_CHARメッセージは、特別な状況下でのみ送信されます。これらの追加入力メッセージを無視することになりますが、現時点ではWM_CHARを処理するだけで、機能が失われることはありません。

</p>

<p>以下のコードは、Win32プログラムで文字入力を処理する標準的な方法です。

</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LONG</span> <span class="n">TextView</span><span class="o">::</span><span class="n">OnChar</span><span class="p">(</span><span class="n">UINT</span> <span class="n">nChar</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">nFlags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// do something with 'nChar'
</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="n">WM_CHAR</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">OnChar</span><span class="p">(</span><span class="n">wParam</span><span class="p">,</span> <span class="n">lParam</span><span class="p">);</span>
</code></pre></div></div>

<p>Unicodeの入力を受け取るために何か特別なことをする必要はありません。UNICODEマクロを定義してコンパイルする限り、UTF-16文字を受け取ることができます。BMPの外にあるUnicodeの値（0xFFFFを超える値）は、2つの別々のメッセージとして送信され、それぞれのサロゲート・キャラクタに1つずつ送られます。しかし、ユーザーが2つのサロゲート値を別々に手動で入力することはほとんどありません。ユーザーはInput Method Editorを使用している可能性が高く、キーボード入力をUTF-16単位に分割するのはIMEです。

</p>

<p>テキストの入力方法に関わらず、必要なことは、TextViewに送られてくるWM_CHARをそれぞれ受け取り、それに応じて処理することです。通常は、ここが難しいところですが、幸いにもピースチェーンシーケンスクラスがあるので、文字を受信するたびに、基礎となるドキュメントに編集を加えることができます。

</p>

<h2 id="integrating-the-piece-table">Integrating the Piece-table</h2>

<p>ピーステーブルをNeatpadに統合する最初の試みは、非常にスムーズに進みました。これがエディタで行う最善の方法であるとは完全には確信していませんが、少なくとも、このアイデアが実際に機能することを示しています。下の図は、現時点でのテキストエディタの様々なコンポーネントを示しています。

</p>

<p><img src="assets/img/editor1813.gif" alt="" class="align-center"></p>

<p>基本的なアイデアは、デザインの他の部分への影響を最小限に抑える方法でピーステーブルを組み込むことです。この目的を達成するために、私は生のファイルコンテンツの上に直接ピーステーブルを重ねました。ピーステーブル（またはシーケンスクラス）は、基礎となるファイルを、WCHARユニットではなくBYTEのシーケンスとして、そのままの形で表示します。今のところ、TextDocumentはUTF-16に変換する前の生の状態のファイルにアクセスできるので、これは理にかなっています。唯一の違いは、TextDocumentが生のファイルの内容を読むだけでなく、ピーステーブルを通して生のファイルに変更を加えることができるということです。

</p>

<p>しかし、すべてがスムーズというわけではありません。このデザインの大きな問題点は、ラインバッファに依存していることです。ラインバッファは、ピーステーブルに変更が加えられるたびに再初期化しなければなりません。これは、ラインバッファがピーステーブルに直接インデックスを付けており、ピーステーブルへの変更（挿入や削除など）がファイルのレイアウトに影響するためです。したがって、ピーステーブルを変更すると、ラインバッファを適切に変更する必要があります。これは非常に小さなファイルではあまり気になりませんが、数kb以上のファイルでは深刻なパフォーマンスの問題が発生します。今回のテキストエディタのダウンロードでは、この問題に気づくでしょう。1文字を挿入するたびに、ラインバッファが再初期化されるため、顕著な遅延が発生します。もちろん、このようなことは許されません。この問題は次のチュートリアルで詳しく説明します。



www.DeepL.com/Translator（無料版）で翻訳しました。</p>

<h2 id="deleting-text">Deleting text</h2>

<p>テキストエディタの主な機能は、テキストの入力ですが、テキストの削除も重要な要素です。そこで、テキストの入力方法を見る前に、テキストの削除に関するいくつかの問題について説明します。

</p>

<p>Unicodeテキストエディタが考慮しなければならない「削除」の基本的な形式は3つあります。1つ目は、ユーザーの現在の選択範囲として定義されている、テキストの静的な範囲の削除です。ここで重要なのは、削除範囲の開始位置と終了位置が明確に定義されていることであり、既存のキーボードやマウスのナビゲーション・ルーチンに頼って、常に適切なクラスタ境界にカーソルを置くようにします。他の2つの削除方法は、Forwards deleteとBackwards deleteです。これらの2つの操作は、通常、標準の<delete>および<backspace>キーに対応しています。これらの2つの削除方法については、もう少し後に説明します。

</backspace></delete></p>

<p>Neatpadでのテキスト削除は、Neatpadがドキュメントの基礎データを管理する方法のため、若干複雑になっています。Neatpadは、基本的に、ASCII、UTF-8、UTF-16フォーマットをサポートするマルチフォーマットのテキストエディタです。そのため、すべてのテキスト座標がUTF-16単位（TextView内）であるにもかかわらず、TextDocumentはこれらの座標を、ドキュメントがどのようなフォーマットであってもマッピングしなければなりません。(この設計については、第9回「Unicodeテキスト処理」で説明しました）。) ドキュメント内のテキストの範囲を削除するには、Neatpadが文字オフセットを基礎となるファイル内の適切な物理的オフセットに変換する必要があります。

</p>

<p>TextDocumentは、エディタのLine-Bufferコンポーネントにアクセスすることで、この変換を行います。ラインバッファの検索はO(log N)時間で行われますが、大きなファイルではこの操作は比較的コストがかかります。この問題は、削除操作が2つの値(削除するテキストの範囲の開始と終了)を入力として受け取り、ラインバッファを2回検索する必要があるためです。理想的ではありませんが、これはエディタがこれまでに進化してきた方法です。UTF-16との変換が必要なのは、Neatpadが複数のファイルフォーマットをサポートしたいからだということを忘れないでください。UTF-8は、UTF-16にまったく対応していないので、この変換が絶対に必要なのです。私はこの「二重座標」デザインから離れることになりそうです。

</p>

<p>理想的な世界では、UTF-8のファイルを完全にメモリに読み込み、最初に開いたときにUTF-16に変換することで、実行時に変換の問題が発生しないようにすることができます。ほとんどのエディターはこのように動いています。このような問題があるのは、「大きなファイル」をサポートしたいという私の意図があるからに他なりません。明らかに、数ギガバイトのテキストファイルは一度にメモリに収まらないので、ファイルを小さな単位でメモリにページングする必要があり、ランタイムにUTF-16との間で変換することが必要になります。しかし、私は現在の「二重座標」システムが本当に好きではありません（扱いが非常に面倒です）。このため、「ラージファイル」サポート（ディスク上での編集）をプレーンなASCIIとUTF-16だけに制限することにするかもしれません。いつものように、皆様からのご意見をお待ちしています。

</p>

<h2 id="backspace-vs-delete">Backspace vs Delete</h2>

<p>これは、Michael KaplanのSorting it all outというブログエントリーのタイトルです。Michaelのブログには、国際化に関する質の高い情報が豊富にあるので、時間をかけて読んでみてください。彼のサイトに掲載されている多くのトピックは、Unicodeを理解する上で非常に役に立ちました。

</p>

<p>deleteとbackspaceはどちらもテキストを削除する方法ですが、実際にはその操作は微妙に異なります。実際には、カーソルの移動方向（論理的なテキスト単位）に合わせて、「Forwards delete」と「Backwards delete」という表現が適しています。この違いは、結合シーケンスを含むUnicodeテキストの文字列を調べることで明らかになります。例として、"Déja "という単語を考えてみましょう。

</p>

<p><img src="assets/img/editor1809.gif" alt="" class="align-center"></p>

<p>ご覧のように、このテキストは5つのコードポイントで構成されており、結合するアキュートアクセント（U+0301）は別の文字として表示されています。もちろん実際には、アキュートアクセントは文字「e」の上に配置され、両者を合わせて1つのグラフェムクラスターとして表示されます。

</p>

<p><img src="assets/img/editor1805.gif" alt="" class="align-center"></p>

<p>Fowards-delete は最初に考えるべきケースであり、基本的なテキストエディタは、<delete> キーが押されるたびに 1 つの Unicode 文字を削除することでこの操作を実装します。しかし、「Déja」の例を見てみると、それよりも少し複雑であることがわかります。

</delete></p>

<p><img src="assets/img/editor1810.gif" alt="" class="align-center"></p>

<p>カーソルが「e」の文字の先頭にあるとします。<delete>を押すと、この一文字は期待通りに消去されます。しかし、Neatpadがdeleteを押すたびに1つのUTF-16文字を削除する場合、結合しているアキュート・アセント文字は削除されません。それどころか、「e」の前の文字（「D」）にくっついてしまい、上のような不正なUnicode配列になってしまいます。

</delete></p>

<p><img src="assets/img/editor1811.gif" alt="" class="align-center"></p>

<p>もちろん、このような場合には、基本文字とそれに続く結合文字を削除するのが論理的です。また、UTF-16のサロゲートペアでも同じように、両方のサロゲートキャラクタが削除されることになります。このような文字の境界条件を特定するために、Uniscribeの「論理属性リスト」が使用されます。

</p>

<p>バックデリートは、実際には少し異なります。今回は、アクセント記号と文字「j」の間にキャレットが置かれているとします。先ほどと同じ理屈でBack-deleteを実行すると、基本文字だけでなく結合文字も削除されます。この方法は間違いではありませんが、より良い方法は、結合文字だけを削除して、「e」をそのままにしておくことです。

</p>

<p><img src="assets/img/editor1812.gif" alt="" class="align-center"></p>

<p><backspace>に対応して単一のUnicode文字を削除することは、結合文字だけがシーケンスの最後から削除され、基本文字がそのまま残るため、望ましいことです。シーケンス全体を削除する必要はありませんし、この1文字だけをミスタイプした場合には、ユーザーに不満を抱かせるだけです。残念ながら、やみくもに1文字の削除を行うだけでは十分ではありません。なぜならば、UTF-16のサロゲートペアを考慮しなければならないからです。先に紹介したブログ記事では、このシナリオについて説明し、このケースでサロゲートペアを適切に処理できないいくつかのWindowsアプリケーションのバグを紹介しています。

</backspace></p>

<p>Unicodeの削除操作をサポートするには、変更するテキストストリームを検査して、結合シーケンス（サロゲートを含む）を適切に処理する必要があります。幸いなことに、Uniscribe を使用しているので、各行について計算された論理属性リストを再び参照することができます。

</p>

<p>ラインターミネーションは、サロゲート／結合配列の問題に加えて、処理しなければならないもう一つのシナリオです。これ自体は特に問題ではありませんが、キャリッジリターンとラインフィードの組み合わせが発生した場合には、特別な注意が必要です。明らかにCR/LFペアは1つのユニットとして扱われなければなりませんが、実際にはサロゲートペアと全く同じ方法で扱われます。

</p>

<p>Neatpadのピーステーブルは、ライン指向のデータ構造ではないので、それ以上の問題はありません。対照的に、「ラインのリンクされたリスト」モデルを利用するエディタでは、ライン（CR/LF）がファイルに追加/削除されるたびに、リストノードを操作する特別なロジックが必要になります。Neatpadのデータ構造は、単純な文字のフラットストリームなので、この問題はありません。

</p>

<h2 id="inserting-text">Inserting text</h2>

<p>Neatpadは、TextView::OnChar関数で文字入力を受け取ります。この関数は、TextViewKeyInput.cppで定義されており、以下のようになっています。

</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LONG</span> <span class="n">TextView</span><span class="o">::</span><span class="n">OnChar</span><span class="p">(</span><span class="n">UINT</span> <span class="n">nChar</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">nFlags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">WCHAR</span> <span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">WCHAR</span><span class="p">)</span><span class="n">nChar</span><span class="p">;</span>

    <span class="c1">// translate carriage-returns to CR/LF combinations
</span>    <span class="k">if</span><span class="p">(</span><span class="n">nChar</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span>
        <span class="n">PostMessage</span><span class="p">(</span><span class="n">m_hWnd</span><span class="p">,</span> <span class="n">WM_CHAR</span><span class="p">,</span> <span class="sc">'\n'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="c1">// input this single character at current cursor position
</span>    <span class="n">EnterText</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="c1">// 'break' piece-table optimizations whenever we input a new line
</span>    <span class="k">if</span><span class="p">(</span><span class="n">nChar</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span>
        <span class="n">m_pTextDoc</span><span class="o">-&gt;</span><span class="n">m_seq</span><span class="p">.</span><span class="n">breakopt</span><span class="p">();</span>

    <span class="n">NotifyParent</span><span class="p">(</span><span class="n">TVN_CHANGED</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>TextView::OnCharは、受け取った各ワイド文字を、より汎用的なEnterText関数に渡すだけで、クリップボード関連のコードでも使用されます。

</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">TextView</span><span class="o">::</span><span class="n">EnterText</span><span class="p">(</span><span class="n">TCHAR</span> <span class="o">*</span><span class="n">szText</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">nLength</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ULONG</span> <span class="n">selstart</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">m_nSelectionStart</span><span class="p">,</span> <span class="n">m_nSelectionEnd</span><span class="p">);</span>
    <span class="n">ULONG</span> <span class="n">selend</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">m_nSelectionStart</span><span class="p">,</span> <span class="n">m_nSelectionEnd</span><span class="p">);</span>

    <span class="n">BOOL</span> <span class="n">fReplaceSelection</span> <span class="o">=</span> <span class="p">(</span><span class="n">selstart</span> <span class="o">==</span> <span class="n">selend</span><span class="p">)</span> <span class="o">?</span> <span class="n">FALSE</span> <span class="o">:</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">m_nEditMode</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">MODE_READONLY</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">MODE_INSERT</span><span class="p">:</span>

        <span class="c1">// remove selection if necessary     
</span>        <span class="k">if</span><span class="p">(</span><span class="n">fReplaceSelection</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">m_pTextDoc</span><span class="o">-&gt;</span><span class="n">m_seq</span><span class="p">.</span><span class="n">group</span><span class="p">();</span>
            <span class="n">m_pTextDoc</span><span class="o">-&gt;</span><span class="n">erase_text</span><span class="p">(</span><span class="n">selstart</span><span class="p">,</span> <span class="n">selend</span><span class="o">-</span><span class="n">selstart</span><span class="p">);</span>
            <span class="n">m_nCursorOffset</span> <span class="o">=</span> <span class="n">selstart</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// enter the text!
</span>        <span class="n">m_pTextDoc</span><span class="o">-&gt;</span><span class="n">insert_text</span><span class="p">(</span><span class="n">m_nCursorOffset</span><span class="p">,</span> <span class="n">szText</span><span class="p">,</span> <span class="n">nLength</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">MODE_OVERWRITE</span><span class="p">:</span>
        <span class="c1">// overwrite happens here 
</span>        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">m_nCursorOffset</span> <span class="o">+=</span> <span class="n">nLength</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>現在の編集モード（MODE_READONLY、MODE_INSERT、MODE_OVERWRITEのいずれか）の状態に応じて、適切なアクションを取るのはEnterTextの責任です。上述の例では「テキスト挿入」のみを示しています。

</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ULONG</span> <span class="n">TextDocument</span><span class="o">::</span><span class="n">insert_text</span><span class="p">(</span><span class="n">ULONG</span> <span class="n">offset_chars</span><span class="p">,</span> <span class="n">WCHAR</span> <span class="o">*</span><span class="n">text</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ULONG</span> <span class="n">offset_bytes</span><span class="p">;</span>

    <span class="n">offset_bytes</span> <span class="o">=</span> <span class="n">charoffset_to_byteoffset</span><span class="p">(</span><span class="n">offset_chars</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">insert_raw</span><span class="p">(</span><span class="n">offset_bytes</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>この段階で注目すべき点は、TextDocument::insert_text関数が、渡されたWCHARバッファに対してどのような処理を行うかということです。まず最初に行われるのは、与えられた文字オフセットを生のバイトオフセットに変換することです。insert_text がテキストをピーステーブルのどこに物理的に挿入すればよいかを知ると、insert_raw 関数が呼び出され、UTF-16 の文字列を適切なテキスト形式に変換します（ファイルがすでに UTF-16 の場合はそのままです）。UTF-16文字列が適切なテキスト形式に変換されます（ファイルがすでにUTF-16の場合は変更されません）。これでテキストが元のファイルと同じ形式になったので、いよいよピーステーブルに挿入されます。

</p>

<h2 id="overwriting-text">Overwriting text</h2>

<p>すべてのテキストエディタは「挿入」モードをサポートしていますが、多くのテキストエディタは「上書き」モードもサポートしています。Neatpadのピーステーブル実装では、すでに「replace」機能を提供しており、消去と挿入を1つのアトミックな操作にまとめています。そのプロトタイプを以下に示します。

</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">size_w</span> <span class="n">sequence</span><span class="o">::</span><span class="n">replace</span><span class="p">(</span><span class="n">size_w</span> <span class="n">index</span><span class="p">,</span> <span class="n">seqchar</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size_w</span> <span class="n">length</span><span class="p">)</span>
</code></pre></div></div>

<p>piece-tableのreplace機能は、まず指定した範囲のテキスト（indexとindex+lengthの間）を消去し、次にバッファ内のデータを同じ場所に戻して挿入します。その結果、バイナリデータの「厳密な」上書きが行われ、操作終了時にファイルの長さは変更されません。この動作は、HexEditの当初の設計から引き継がれたものです。

</p>

<p>Unicodeでテキストを上書きすることは、単純なバイト（または文字）の置き換えよりも複雑です。これは、Neatpadでファイルを編集し始めたときにわかりました。テキストの上書きは、すでに「前方消去」で説明したのとまったく同じルールに従わなければなりません。つまり、テキストを置き換える際には、クラスタの境界と結合シーケンスを尊重しなければなりません。次の例では、「上書き」モードで「o」の文字を入力しています。

</p>

<p><img src="assets/img/editor1818.gif" alt="" class="align-center"></p>

<p>最終的には、キーボードで入力した1文字ごとに、数個のUTF-16文字を削除しなければならないということになります。言い換えれば、Unicodeテキストエディタの「置換」操作は、編集中のファイルの長さを変えてしまう可能性があるということです。これは、編集中のファイルの長さを絶対に変えてはならないバイナリエディタとは全く対照的である。残念ながら、これがテキストエディタの仕組みであり、私たちはこのような事態に対処する準備をしなければなりません。

</p>

<h2 id="replacing-past-the-end-of-line">Replacing past the end of line</h2>

<p>行末を超えての置き換え（上書き）も、対応しなければならないシナリオの一つです。繰り返しになりますが、実際にエディタを使ってみて初めて、これが問題であることに気づきました。簡単な例として、次の2行のテキストを考えてみましょう。1行目の終わりにキャレットを置いています。

</p>

<p><img src="assets/img/editor1815.gif" alt="" class="align-center"></p>

<p>エディタではテキストを2行に分けて表示していますが、Neatpadのピーステーブルでは、ファイルの内容をシンプルなテキストの流れとして表示していることを覚えておいてください。

</p>

<p><img src="assets/img/editor1816.gif" alt="" class="align-center"></p>

<p>既存のフォワードデリートロジックを「オーバーライトモード」で使用すると、次の文字が入力されたときにCR+LFの組み合わせが削除されます。このようにしてラインターミネーターを消去すると、2つのラインを結合する効果があります。

</p>

<p><img src="assets/img/editor1817.gif" alt="" class="align-center"></p>

<p>明らかに、これはテキストエディタに期待する動作ではありません。したがって、Neatpadは、上書きモードの間、CR/LF文字を特別に扱わなければなりません。実際、CR/LFの直前に入力されたテキストは、エディタが上書きモードであるかどうかに関わらず、実際にドキュメントに挿入されなければなりません（行の長さが延長されます）。

</p>

<p>CR/LFのシナリオは，最初に結合配列を上書きしたときに見たのと同じ，sequence::replace関数の欠陥を浮き彫りにしています．根本的な問題は，削除したいバイト（または文字）の数と，置き換えたい文字の数が一致しないことです．そのため、任意の置換操作で削除するバイト数を正確に制御できる必要があります。

</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sequence</span><span class="o">::</span><span class="n">replace</span><span class="p">(</span> <span class="n">size_w</span> <span class="n">index</span><span class="p">,</span> 
                   <span class="k">const</span> <span class="n">seqchar</span> <span class="o">*</span> <span class="n">buffer</span><span class="p">,</span> 
                   <span class="n">size_w</span> <span class="n">length</span><span class="p">,</span> 
                   <span class="n">size_w</span> <span class="n">erase_length</span>
  <span class="p">);</span>
</code></pre></div></div>

<p>erase_lengthパラメータを追加することで、どのような形式の置換操作にも柔軟に対応できるようになりました。結合シーケンスを置換する場合、このパラメータには結合シーケンスがファイル内で占めるバイト数が設定されます。上記のCR/LFのシナリオでは、このパラメータはゼロに設定されます。

</p>

<h2 id="optimized-insert-and-replace">Optimized insert and replace</h2>

<p>上の例では，sequence::replaceではなく，sequence::insertを呼べばよかったのではないかと思うかもしれません．その理由は簡単です。Neatpadのピーステーブルは、挿入/置換の各操作を最適化するように設計されています。（同じタイプの）連続した編集を単一の操作にまとめることで、ピーステーブル内のスパン数を常に最小に保つことができます。テキストを入力するときに sequence::replace を呼び出し、CR/LF を処理するときに sequence::insert を呼び出すように変更した場合、最適化された操作が「replace」と「insert」の操作に分かれてしまいます。これは、ユーザーにとって直感的に理解できるものではありません。ユーザーは、上書きされたテキストが1つの操作として扱われることを期待するでしょう。問題を複雑にするのではなく、単純にsequence::replace関数の機能を拡張することにしました。

</p>

<p>CR/LF の組み合わせや配列の最適化の話をしているときに、ユーザーが実際に CR/LF を文書に入力したとき (削除するのではなく)、何が起こるかについて言及する価値があるでしょう。Neatpadのピーステーブルは、当然CR/LFの文字を受け取り、可能な限り編集操作をまとめます。ユーザーが一度に数行のテキストを連続して入力した場合（元に戻す/削除/やり直すことなく）、すべての行のテキストが1つの操作に最適化されます。この最適化の結果は、ユーザーが後にテキスト挿入を元に戻そうとしたときに、入力したテキストのすべての行が一度に元に戻されていることに気づくでしょう。

</p>

<p>これは実際にはあまり直感的ではないことがわかりました。それよりも，新しい行が始まるたびにシーケンスの最適化が「中断」されることが望ましいのです．言い換えれば，シーケンスはテキストの行全体を最適化するだけで，それ以上は最適化しないということです．このモデルをサポートするために，新しい関数 sequence:: breakopt が導入されました．

</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">sequence</span><span class="o">::</span><span class="n">breakopt</span><span class="p">()</span>
</code></pre></div></div>

<p>この関数は、ドキュメントに1つのキャリッジ・リターンが入力されるたびに呼び出されます。エディタはもともと行指向なので、この結果はより自然なものとなります。このようにシーケンス最適化を解除することで、各行を個別にアンドゥ/リドゥンすることができます。その結果、ピーステーブルに導入されるスパンが増えることになりますが、使いやすさとパフォーマンスは常にトレードオフの関係にあります。しかし、ユーザビリティとパフォーマンスは常にトレードオフの関係にあります。私の考えでは、ユーザが理解できず、気にも留めないような最適化動作を強制するよりも、ユーザの全体的な体験を向上させる方が良いと思います。

</p>

<h2 id="undo-and-redo">Undo and Redo</h2>

<p>元に戻す」「やり直し」の機能は、多くのテキストエディタにとって常に基本的な要素です。しかし、中には優れたものもあります。最も優れたエディタは、通常、最初からアンドゥをサポートしています。Neatpadのために開発されたピーステーブルの実装は、無制限のアンドゥとリドゥを提供しています。これ自体は非常に素晴らしい機能ですが、ピーステーブルがNeatpadに統合されると、興味深い問題が発生します。

</p>

<p>この問題は、選択範囲のハイライトとキャレットの配置に関するものです。気づいている人もいない人もいるかもしれませんが、お気に入りのエディタでアンドゥ（またはリドゥ）を実行すると、テキストキャレットは、最後の操作が行われたオフセットに自動的に再配置されます。つまり、テキストシーケンスにアクションを起こすたびに、ピーステーブルはそれらの操作で指定された論理的オフセットを追跡しなければならないのです。アンドゥによりシーケンスが復元された場合、アンドゥ/リドゥの結果としてシーケンス内のどの範囲のデータが変更されたかを詳細に示すことができなければなりません。

</p>

<p>簡単な例として、お気に入りのエディタを起動し、ファイルを開きます。テキストの範囲を選択して削除し、カーソルをファイル内の別の場所に置きます。エディターで「取り消し」をクリックします。削除したテキストの範囲がファイルに挿入され、編集する直前の状態に戻ります。この目的を達成するために、シーケンスクラスは、各操作のオフセットと長さを、対応するspan_rangeオブジェクトに格納します。シーケンスクラスには，これらの内部情報にアクセスするための2つのメソッドが用意されています．

</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">size_w</span> <span class="n">sequence</span><span class="o">::</span><span class="n">event_index</span><span class="p">();</span><span class="n">size_w</span> <span class="n">sequence</span><span class="o">::</span><span class="n">event_length</span><span class="p">();</span>
</code></pre></div></div>

<p>TextViewは、エディタ内でアンドゥやリドゥが発生するたびに、これら2つのメソッドを呼び出します。event_index()関数は、最後の操作の論理的オフセットを提供し、一方event_length()は、関係するデータの長さを提供します。アンドゥやリドゥが発生するたびに、シーケンスの内部状態が変化し、これらの2つの関数は、これらのアクションを表す適切な値を返します。これらの情報が必要なのは、アンドゥ／リドゥの際にキャレットの位置を変更するためだけですが、それでもユーザーインターフェースの重要な要素です。

</p>

<h2 id="caret-placement">Caret Placement</h2>

<p>これまで、エディタにテキストを入力することができなかったため、Neatpadのキーボードナビゲーションの動作をテストすることは困難でした。その結果、双方向テキストのキャレットの位置にバグがあることが判明しました。私は論理的に正しいとは思っていませんでしたが、Neatpadを使って英語とアラビア語の混在したテキストを編集することでそれが確認できました。

</p>

<p>Uniscribeのトピック「Display the Caret in Bidirectional Strings」（MSDN）では、この問題を "in bidirectional text, the caret position between runs of opposing direction is ambiguous "と表現しています。これが意味するところは、英語とアラビア語の両方のテキストを含む文字列の場合、文字列内の特定の文字オフセットでは、キャレットが複数の可視位置に表示される可能性があるということです。

</p>

<p>よく知られている「HelloيُساوِيWorld」の例をもう一度見てみましょう。キャレットの位置は文字列のオフセット5です。

</p>

<p><img src="assets/img/editor1819.gif" alt="" class="align-center"></p>

<p>上の例では、テキストキャレットの位置が2つあることがわかります。この曖昧さは、「Hello」の最後の文字が「يُساوِي」の最初の文字のすぐ前にあるために生じます。アラビア語の文字列は右から左に印刷されるので、カレットの位置は2つになります。これは、カレットが「hello」の「o」の後にあると考えるか、それとも「يُساوِي」の最初の文字の前にあると考えるかによるものです。

</p>

<p>したがって、Unicodeテキストでは、キャレットは文字の先頭または末尾に表示されると考えることができます。別の考え方をすると、キャレットの位置は、キャレットがテキストの中で前方に進んでいるか、後方に進んでいるかによって決まります。したがって、双方向テキストをサポートするテキストエディタは、キャレットを配置する際に、この区別をしなければなりません。単にカーソルのオフセットを目に見えるX座標に変換するだけでは十分ではありません。カーソルの移動方向も考慮に入れなければなりません。

</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span> <span class="n">fAdvancing</span> <span class="p">)</span>
    <span class="n">ScriptCPtoX</span><span class="p">(</span><span class="n">nCursorOffset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="p">...,</span> <span class="o">&amp;</span><span class="n">iCaretX</span><span class="p">);</span>
<span class="k">else</span>
    <span class="n">ScriptCPtoX</span><span class="p">(</span><span class="n">nCursorOffset</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="p">...,</span> <span class="o">&amp;</span><span class="n">iCaretX</span><span class="p">);</span>
</code></pre></div></div>

<p>キャレットが前方に進んでいる場合は、前の文字の先頭に配置され、キャレットが後方に進んでいる場合は、現在の文字の後端に配置されます。この新しいロジックは、Neatpadでは、TextViewが内部的に使用しているUpdateCaretOffset関数に変更を加えて表現しています。

</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">VOID</span> <span class="n">TextView</span><span class="o">::</span><span class="n">UpdateCaretOffset</span><span class="p">(</span> <span class="n">ULONG</span> <span class="n">nCursorOffset</span><span class="p">,</span> 
                                  <span class="n">BOOL</span> <span class="n">fAdvancing</span><span class="p">,</span> 
                                  <span class="kt">int</span> <span class="o">*</span> <span class="n">outx</span><span class="p">,</span> 
                                  <span class="n">ULONG</span> <span class="o">*</span> <span class="n">outlineno</span> <span class="p">)</span>
</code></pre></div></div>

<p>character-offsetに加えて、fAdvancingパラメータが必要になりました。UpdateCaretOffsetは、上記のロジックを適用して、双方向の文字列に対してキャレットを正しく配置します。キーボードナビゲーションのコードを調整することもそれほど難しくありませんでした。必要な変更は、カーソルの移動方向に応じて fAdvancing 変数を設定することだけです。VK_LEFT や VK_BACKSPACE のようなキーは、テキストを後方に移動すると考えられるので、fAdvancing は FALSE に設定されます。その他のキーでは、fAdvancingはTRUEに設定されます。例えば、以下のようになります。

</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="n">VK_LEFT</span><span class="p">:</span> 
    <span class="n">fAdvancing</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span> 
    <span class="n">nCursorOffset</span> <span class="o">--</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>

<span class="k">case</span> <span class="n">VK_RIGHT</span><span class="p">:</span>
    <span class="n">fAdvancing</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nCursorOffset</span> <span class="o">++</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="vista-is-here">Vista is here</h2>

<p>好むと好まざるとにかかわらず、Vistaの登場は間近に迫っています。私自身、Vistaのファンになるかどうかはまだ決めかねていますが、Neatpadはこの新しいオペレーティングシステムの下で正しく動作させるために、いくつかの修正が必要です。この問題は、管理者権限とVistaの新しいユーザーアカウント制御プロンプトに関連しています。問題は、Neatpadのオプションダイアログが呼び出されたときに発生します。なぜなら、いくつかの設定（「エクスプローラーのコンテキストメニューにNeatpadを追加する」と「メモ帳をデフォルトのエディタに置き換える」）が、レジストリのHKEY_LOCAL_MACHINEブランチへの書き込みアクセスを必要とするからです。明らかにこれにはAdministrator権限が必要であり、Vistaの解決策は、アプリケーションに新しいUser Account Controlガイドラインへの準拠を求めることである。

</p>

<p><img src="assets/img/editor1814.jpg" alt="" class="align-center"></p>

<p>最初の顕著な変化は、新しいVistaシールドアイコンです。これは、UACプロンプトを介して管理者への昇格が必要であることをユーザーに示すものです。アプリケーションプログラマがUACプロンプトを呼び出すには、3つのメカニズムがあります。

</p>

<ol>
  <li>実行ファイルのリソースに、どの昇格レベルが必要かを示すUACマニフェスト（XMLファイル）を埋め込みます。requestedPrivilegesセクションの選択肢は、'asInvoker'、'requireAdministrator'、'highestAvailable'です。この方法で「requireAdministrator」を採用することもできますが、問題は、Neatpadを実行するたびにUACプロンプトが表示されることです。特に、管理者のアクセスが必要になるのは、2つの「システム設定」を変更する必要があるときだけなので、これはユーザーにとって非常にイライラすることでしょう。これは、古いアプリケーションをサポートするためにのみ意図されているスレッジハンマーのようなアプローチであり、Neatpadのようなシンプルなユーティリティには適していません。
</li>
  <li>2つ目の方法は、新しい CoCreateInstanceAsAdmin 関数コールを使用することです。この新しいCOM APIにより、プログラムは管理者レベルのCOMオブジェクトをインスタンス化することができます（もちろん、現在のユーザーが管理者グループのメンバーであることが前提です！）。このCOMオブジェクトは別のプロセス内に存在し、呼び出し側のアプリケーションがオブジェクトに対して制御された呼び出しを行うことができます。この方法は技術的には優れていますが、2つの問題があります。1つ目は、外部のDLLを出荷する必要があること、2つ目は、そもそもレジストリにCOM DLLをインストールするために、Administratorでなければならないことです。この方法は、適切なWindowsインストーラーを使用する大規模なアプリケーションに最も適しています。
</li>
  <li>最後の選択肢は、管理者レベルで別のプロセスを生成することです。この場合、"runas "動詞を使用してShellExecuteEx関数を呼び出すことができます。Vistaで実行する場合は、新しい実行ファイルを起動する前にUACプロンプトが表示されます。子プロセスは、ユーザーが昇格を許可したと仮定して、Administrator権限で実行されます。
</li>
</ol>

<p>Neatpadは#3のオプションを使用していますが、別のプログラムを起動するのではなく、単に自分自身を再起動しようとします。特別なコマンドラインオプション("-uac")は、新しいインスタンスがGUIを表示しないように指示するために使用されます。この特別なモードでは、Neatpadは、HKEY_LOCAL_MACHINEの下に適切なレジストリキーを設定して終了します。リスポーンしたNeatpadはAdministratorとして実行されるので、レジストリアクセスは成功します。

</p>

<h2 id="conclusion">Conclusion</h2>

<p>ユニコードのテキスト編集は、主に結合シーケンスの発生により、複雑な問題です。幸いなことに、Uniscribe APIは、私たちが他の方法で行わなければならないかもしれない作業量を大幅に単純化してくれます。今回のテーマは、エディターのデザインに非常にうまく適合した、しっかりとしたピーステーブルの実装があったことにも大いに助けられました。エディタを書く人には、機能的なバックエンドの開発に時間をかけることを強くお勧めします。必要なすべての編集操作とundo/redoのサポートを含むべきです。

</p>

<p>Neatpadの編集機能が完全に完成するまでには、まだ長い道のりがあります。ラインバッファの実装は早急に改善する必要があり、これは次のチュートリアルのテーマになります。これは、ピーステーブルがディスク上での編集に適していることから、非常に簡単なテーマであることが期待されます。

</p>

<p><img src="assets/img/editor1820.jpg" alt="" class="align-center"></p>

<p>Windows Vistaで動作するNeatpadは、Aero Glassテーマを使用しています。

</p>

<p>前回、Visual Studio 2005とC++テンプレートへの移行を考えていると書きました。しかし、この時点で私は当面VC6を使うことにしました。まず、シーケンスクラスは生のバイトを格納するためだけに使用されているので、C++テンプレートは不要です。第二に、VC2005の実行ファイルは、Windowsシステムにデフォルトでは存在しない新しいCランタイムDLL(MSVCRT8.DLL)に依存しています。そのため、問題を複雑にするよりも、NeatpadプロジェクトはVC6との互換性を保ちつつ、VC2005でもきれいにビルドできるようになっています。

</p>

<p>その間に、いくつかの興味深いエディターに出会ったので、紹介したいと思います。一つ目は、Jujusoft社のJujuEditです。これはフリーウェアですが、クローズドソースです。このエディタは「非常に大きなファイルをサポート」しており、最大で2Gbのファイルを扱うことができ、実際に大きなファイルを扱うことができるのが印象的です。次はIntypeで、これはまだ開発中の面白いエディタのようです。また、Windows用の共同テキストエディタであるeは、undo/redoに対する面白いアプローチを持っています。最後の2つのリンクを提供してくれたFranck Marcia氏に感謝します。

</p>

<p>また、正規表現ベースのシンタックスカラーリングのための非常に素晴らしいオープンソースのライブラリであるColorerを紹介してくれた皆さんにも感謝します。Neatpadにシンタックスカラーリングを実装する時が来たら、このライブラリがあればずっと楽になると思います。

</p>



  <div class="file-attachments">
    <h4>DOWNLOADS</h4>
    
      
       <a href="assets/files/neatpad18.zip">neatpad18.zip</a>      
    
  </div>

        
      </section>

      <footer class="page__meta">
        
        


        
          <p class="page__date"><strong><svg class="svg-inline--fa fa-calendar-alt fa-w-14 fa-fw" aria-hidden="true" data-prefix="fas" data-icon="calendar-alt" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M0 464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V192H0v272zm320-196c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zm0 128c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zM192 268c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zm0 128c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zM64 268c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12H76c-6.6 0-12-5.4-12-12v-40zm0 128c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12H76c-6.6 0-12-5.4-12-12v-40zM400 64h-48V16c0-8.8-7.2-16-16-16h-32c-8.8 0-16 7.2-16 16v48H160V16c0-8.8-7.2-16-16-16h-32c-8.8 0-16 7.2-16 16v48H48C21.5 64 0 85.5 0 112v48h448v-48c0-26.5-21.5-48-48-48z"></path></svg><!-- <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> --> Updated:</strong> <time datetime="2006-11-28T00:00:00+00:00">November 28, 2006</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="piece-chains.html" class="pagination--pager" title="Piece Chains
">Previous</a>
    
    
      <a href="../../tuts/win32/2012-01-22-c-and-c-tricks/index.html" class="pagination--pager" title="C &amp; C++ Tricks
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    

    <div class="page__footer" style="">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="../../feed.xml"><svg class="svg-inline--fa fa-rss-square fa-w-14 fa-fw" aria-hidden="true" data-prefix="fas" data-icon="rss-square" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM112 416c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm157.533 0h-34.335c-6.011 0-11.051-4.636-11.442-10.634-5.214-80.05-69.243-143.92-149.123-149.123-5.997-.39-10.633-5.431-10.633-11.441v-34.335c0-6.535 5.468-11.777 11.994-11.425 110.546 5.974 198.997 94.536 204.964 204.964.352 6.526-4.89 11.994-11.425 11.994zm103.027 0h-34.334c-6.161 0-11.175-4.882-11.427-11.038-5.598-136.535-115.204-246.161-251.76-251.76C68.882 152.949 64 147.935 64 141.774V107.44c0-6.454 5.338-11.664 11.787-11.432 167.83 6.025 302.21 141.191 308.205 308.205.232 6.449-4.978 11.787-11.432 11.787z"></path></svg><!-- <i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> --> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">© 2019 Catch22. Powered by <a href="https://jekyllrb.com/index.html" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/index.html" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="assets/js/main.min.js"></script>
  <script defer="" src="https://use.fontawesome.com/releases/v5.6.0/js/all.js" integrity="sha384-z9ZOvGHHo21RqN5De4rfJMoAxYpaVoiYhuJXPyVmSs8yn20IE3PmBM534CffwSJI" crossorigin="anonymous"></script>








  

</body></html>